# build.ninja - Ninja build file for phys project
# Targets are sorted alphabetically

# Simple rule for running shell commands
rule run
  command = $cmd
  description = $desc

# Build the project using CMake
build build: run | $
    CMakeLists.txt $
    inc/example/functions.h $
    inc/example/functions_bindings.h $
    inc/math/constants.h $
    inc/math/linalg/linalg_bindings.h $
    inc/math/linalg/vector.h $
    inc/math/linalg/vector_bindings.h $
    inc/math/math_bindings.h $
    python/CMakeLists.txt $
    python/main.cpp $
    python/phys/example/CMakeLists.txt $
    python/phys/example/example_bindings.cpp $
    python/phys/example/main.cpp $
    python/phys/math/CMakeLists.txt $
    python/phys/math/linalg/linalg_bindings.cpp $
    python/phys/math/linalg/vector_bindings.cpp $
    python/phys/math/main.cpp $
    python/phys/math/math_bindings.cpp $
    src/CMakeLists.txt $
    src/example/CMakeLists.txt $
    src/example/functions.cpp $
    src/math/CMakeLists.txt $
    src/math/linalg/CMakeLists.txt $
    src/math/linalg/vector.cpp $
    tests/CMakeLists.txt
  cmd = cmake -S . -B build -GNinja && cmake --build build
  desc = Building project with CMake
  pool = console

# Build container for the specified platform architecture
# Usage: ninja build-container (defaults to x86_64)
#        PLATFORM_ARCH=aarch64 ninja build-container
build build-container: run
  cmd = docker build . -f Containerfile -t phys --build-arg PLATFORM_ARCH=$${PLATFORM_ARCH:-x86_64} && docker container rm phys-builder || true && docker create --name phys-builder phys && mkdir -p dist && docker cp phys-builder:/app/wheelhouse/. dist/ && docker container rm phys-builder
  desc = Building container for platform $${PLATFORM_ARCH:-x86_64}

# Version bump using commitizen
build bump: run
  cmd = cz bump -s
  desc = Bumping version with commitizen

# Run all CI actions
build ci: run
  cmd = ninja build && ninja format && ninja lint && ninja test
  desc = Running all CI actions
  pool = console

# Clean the build directory
build clean: run
  cmd = cmake --build build --target clean && ruff clean
  desc = Cleaning build directory

# Full clean - remove build directory
build clean-full: run
  cmd = rm -rf build/
  desc = Full clean - removing build directory

# Run formatting tasks
build format: run
  cmd = find src -iname '*.h' -o -iname '*.cpp' | xargs clang-format -i && ruff format src
  desc = Formatting code

# Install the python package
build install: run
  cmd = pip install . --no-deps --force-reinstall -v
  desc = Installing python package
  pool = console

# Run linting tasks
build lint: run
  cmd = run-clang-tidy -p build -header-filter=".*/inc/.*" -exclude-header=".*extern.*" python src tests && ruff check python --exclude "*.pyi"
  desc = Linting code
  pool = console

# Generate python stubs
build stubs: run
  cmd = pybind11-stubgen --output python phys
  desc = Generating python stubs

# Run all tests
build test: run
  cmd = ninja test-cpp && ninja test-python
  desc = Running all tests
  pool = console

# Run C++ core unit tests
build test-cpp: run
  cmd = cd build/tests && ctest --output-on-failure
  desc = Running C++ unit tests
  pool = console

# Run python problem set tests
build test-python: run
  cmd = python -m pytest -v
  desc = Running python tests
  pool = console

# Package as wheel
build wheel: run
  cmd = python -m build --wheel
  desc = Building python wheel
  pool = console

# Default target
default build
